{% extends 'base.html' %}
{% load budget_extras %}

{% block title %}Reports - Budget Planner{% endblock %}

{% block extra_css %}
<style>
  .modern-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fc 100%);
    border: none;
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .modern-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.4),
      transparent
    );
    transition: left 0.5s ease;
  }

  .modern-card:hover::before {
    left: 100%;
  }

  .modern-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  }

  .page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 20px;
    margin-bottom: 2.5rem;
    padding: 2.5rem;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
  }

  .page-header::before {
    content: "";
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(
      circle,
      rgba(255, 255, 255, 0.1) 0%,
      transparent 70%
    );
    animation: float 6s ease-in-out infinite;
  }

  @keyframes float {
    0%,
    100% {
      transform: translateY(0px) rotate(0deg);
    }
    50% {
      transform: translateY(-20px) rotate(180deg);
    }
  }

  .chart-container {
    background: linear-gradient(135deg, #f8f9fc 0%, #ffffff 100%);
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
  }

  .category-item {
    background: linear-gradient(135deg, #f8f9fc 0%, #ffffff 100%);
    border-radius: 10px;
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
    border-left: 4px solid var(--category-color, #007bff);
    transition: all 0.3s ease;
  }

  .category-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
</style>
{% endblock %} {% block content %}
<!-- Page Header -->
<div class="page-header">
  <div class="row align-items-center">
    <div class="col">
      <h1 class="mb-2"><i class="fas fa-chart-bar"></i> Financial Reports</h1>
      <p class="mb-0 opacity-75">
        Comprehensive analysis of your financial patterns and trends
      </p>
    </div>
  </div>
</div>

<!-- Financial Analysis Cards -->
<div class="row">
  <!-- Current Month Breakdown -->
  <div class="col-lg-6 mb-4">
    <div class="modern-card h-100">
      <div
        class="card-header border-0"
        style="background: transparent; padding: 2rem 2rem 1rem"
      >
        <h4 class="mb-0">
          <i class="fas fa-pie-chart text-primary"></i> Monthly Expense
          Breakdown
        </h4>
        <p class="text-muted mt-1 mb-0">
          Detailed view of your spending categories
        </p>
      </div>
      <div class="card-body" style="padding: 1rem 2rem 2rem">
        {% if expense_by_category %}
        <div class="chart-container mb-4">
          <canvas id="expenseBreakdownChart"></canvas>
        </div>
        <div class="category-legend">
          {% for expense in expense_by_category %}
          <div
            class="category-item"
            style="--category-color: {{ expense.category__color }};"
          >
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <div
                  style="width: 12px; height: 12px; border-radius: 50%; background: {{ expense.category__color }}; margin-right: 0.5rem;"
                ></div>
                <span class="fw-bold">{{ expense.category__name }}</span>
              </div>
              <span class="badge bg-primary rounded-pill"
                >${{ expense.total|floatformat:2 }}</span
              >
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
          <div
            style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              border-radius: 50%;
              width: 100px;
              height: 100px;
              margin: 0 auto 1.5rem;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            <i class="fas fa-chart-pie fa-3x text-white"></i>
          </div>
          <h5 class="text-muted">No Expense Data</h5>
          <p class="text-muted">
            Start adding transactions to see your spending breakdown
          </p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Monthly Trends -->
  <div class="col-lg-6 mb-4">
    <div class="modern-card h-100">
      <div
        class="card-header border-0"
        style="background: transparent; padding: 2rem 2rem 1rem"
      >
        <h4 class="mb-0">
          <i class="fas fa-line-chart text-success"></i> 6-Month Financial
          Trends
        </h4>
        <p class="text-muted mt-1 mb-0">
          Track your financial progress over time
        </p>
      </div>
      <div class="card-body" style="padding: 1rem 2rem 2rem">
        <div class="chart-container">
          <canvas id="monthlyTrendsChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mt-4">
  <!-- Top Spending Categories -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5>
          <i class="fas fa-trophy"></i> Top Spending Categories (Last 3 Months)
        </h5>
      </div>
      <div class="card-body">
        {% if top_categories %} {% for category in top_categories %}
        <div
          class="d-flex justify-content-between align-items-center mb-3 p-2 border-bottom"
        >
          <div>
            <strong>{{ category.category__name }}</strong>
            <div class="progress mt-1" style="height: 5px">
              <div
                class="progress-bar bg-primary"
                style="width: {% widthratio category.total top_categories.0.total 100 %}%"
              ></div>
            </div>
          </div>
          <span class="badge bg-primary"
            >${{ category.total|floatformat:2 }}</span
          >
        </div>
        {% endfor %} {% else %}
        <div class="text-center py-4">
          <i class="fas fa-chart-bar fa-2x text-muted mb-3"></i>
          <p class="text-muted">No spending data available.</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Financial Summary -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-calculator"></i> Financial Insights</h5>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-4">
            <div class="border-end">
              <h4 class="text-success">
                ${{ monthly_trends.0.income|floatformat:2 }}
              </h4>
              <small class="text-muted">This Month Income</small>
            </div>
          </div>
          <div class="col-4">
            <div class="border-end">
              <h4 class="text-danger">
                ${{ monthly_trends.0.expenses|floatformat:2 }}
              </h4>
              <small class="text-muted">This Month Expenses</small>
            </div>
          </div>
          <div class="col-4">
            <h4
              class="{% if monthly_trends.0.savings >= 0 %}text-success{% else %}text-danger{% endif %}"
            >
              ${{ monthly_trends.0.savings|floatformat:2 }}
            </h4>
            <small class="text-muted">This Month Savings</small>
          </div>
        </div>

        <hr />

        <div class="mt-4">
          <h6>Financial Health Indicators</h6>

          <!-- Savings Rate -->
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <span>Savings Rate</span>
              <span>
                {% if monthly_trends.0.income > 0 %} {% widthratio
                monthly_trends.0.savings monthly_trends.0.income 100 %}% {% else
                %} 0% {% endif %}
              </span>
            </div>
            <div class="progress mt-1">
              <div
                class="progress-bar bg-success"
                style="width: {% if monthly_trends.0.income > 0 %}{% widthratio monthly_trends.0.savings monthly_trends.0.income 100 %}{% else %}0{% endif %}%"
              ></div>
            </div>
            <small class="text-muted">Aim for 20% or higher</small>
          </div>

          <!-- Expense Ratio -->
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <span>Expense Ratio</span>
              <span>
                {% if monthly_trends.0.income > 0 %} {% widthratio
                monthly_trends.0.expenses monthly_trends.0.income 100 %}% {%
                else %} 0% {% endif %}
              </span>
            </div>
            <div class="progress mt-1">
              {% if monthly_trends.0.income > 0 %} {% widthratio
              monthly_trends.0.expenses monthly_trends.0.income 100 as
              expense_ratio %}
              <div
                class="progress-bar {% if expense_ratio > 80 %}bg-danger{% elif expense_ratio > 60 %}bg-warning{% else %}bg-success{% endif %}"
                style="width: {{ expense_ratio }}%"
              ></div>
              {% else %}
              <div class="progress-bar bg-success" style="width: 0%"></div>
              {% endif %}
            </div>
            <small class="text-muted">Keep below 80% of income</small>
          </div>
        </div>

        <div class="alert alert-info mt-3">
          <i class="fas fa-lightbulb"></i>
          <strong>Tip:</strong>
          {% if monthly_trends.0.savings >= 0 %} Great job saving this month!
          Consider increasing your emergency fund. {% else %} You spent more
          than you earned this month. Review your budget to identify areas to
          cut back. {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Expense Breakdown Chart
      {% if expense_by_category %}
      const expenseCtx = document.getElementById('expenseBreakdownChart').getContext('2d');
      new Chart(expenseCtx, {
          type: 'doughnut',
          data: {
              labels: [{% for expense in expense_by_category %}'{{ expense.category__name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
              datasets: [{
                  data: [{% for expense in expense_by_category %}{{ expense.total }}{% if not forloop.last %},{% endif %}{% endfor %}],
                  backgroundColor: [{% for expense in expense_by_category %}'{{ expense.category__color }}'{% if not forloop.last %},{% endif %}{% endfor %}],
                  borderWidth: 2,
                  borderColor: '#fff'
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      display: false
                  },
                  tooltip: {
                      callbacks: {
                          label: function(context) {
                              const label = context.label || '';
                              const value = context.parsed;
                              const total = context.dataset.data.reduce((a, b) => a + b, 0);
                              const percentage = ((value / total) * 100).toFixed(1);
                              return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                          }
                      }
                  }
              }
          }
      });
      {% endif %}

      // Monthly Trends Chart
      const trendsCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
      new Chart(trendsCtx, {
          type: 'line',
          data: {
              labels: [{% for trend in monthly_trends %}'{{ trend.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
              datasets: [{
                  label: 'Income',
                  data: [{% for trend in monthly_trends %}{{ trend.income }}{% if not forloop.last %},{% endif %}{% endfor %}],
                  borderColor: '#28a745',
                  backgroundColor: 'rgba(40, 167, 69, 0.1)',
                  tension: 0.4,
                  fill: false
              }, {
                  label: 'Expenses',
                  data: [{% for trend in monthly_trends %}{{ trend.expenses }}{% if not forloop.last %},{% endif %}{% endfor %}],
                  borderColor: '#dc3545',
                  backgroundColor: 'rgba(220, 53, 69, 0.1)',
                  tension: 0.4,
                  fill: false
              }, {
                  label: 'Savings',
                  data: [{% for trend in monthly_trends %}{{ trend.savings }}{% if not forloop.last %},{% endif %}{% endfor %}],
                  borderColor: '#007bff',
                  backgroundColor: 'rgba(0, 123, 255, 0.1)',
                  tension: 0.4,
                  fill: false
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                  y: {
                      beginAtZero: true,
                      ticks: {
                          callback: function(value) {
                              return '$' + value.toFixed(0);
                          }
                      }
                  }
              },
              plugins: {
                  legend: {
                      position: 'bottom'
                  },
                  tooltip: {
                      callbacks: {
                          label: function(context) {
                              return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                          }
                      }
                  }
              }
          }
      });
  });
</script>
{% endblock %}
